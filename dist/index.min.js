var err,xlfWorker,xlfMerger,xlfont,xfl;function import$(t,e){var n,r={}.hasOwnProperty;for(n in e)r.call(e,n)&&(t[n]=e[n]);return t}err=function(t){return null==t&&(t={}),import$(new Error,import$({name:"lderror"},t))},xlfWorker={key:0,worker:null,queue:[],init:function(t){var r=this;if(null==t&&(t={}),!this.worker)return this.worker=new Worker(t.url||"worker.min.js"),this.worker.onmessage=function(t){var e=t.data,t=e.buf,n=e.key;if(e=r.queue.filter(function(t){return n===t.key})[0])return r.queue.splice(r.queue.indexOf(e),1),e.res(t)}},run:function(n,r){var o=this;return new Promise(function(t,e){return o.init(r),o.queue.push(e={res:t,rej:e,key:o.key++}),o.worker.postMessage({bufs:n,key:e.key,lib:r.opentype})})}},xlfMerger=function(t){var e=t.bufs,t=t.useWorker;return e.length?t?xlfWorker.run(e,t):Promise.resolve().then(function(){return e.map(function(t){return opentype.parse(t)})}).then(function(t){for(var e,n,r,o,i,s=[],u=0,f=t.length;u<f;++u)for(n=0,r=(e=t[u]).glyphs.length;n<r;++n)o=n,s.push(e.glyphs.glyphs[o]);return e=t[0],new opentype.Font(((i={glyphs:s,familyName:e.names.fontFamily.en,styleName:e.names.fontSubfamily.en}).unitsPerEm=e.unitsPerEm,i.ascender=e.ascender,i.descender=e.descender,i)).toArrayBuffer()}):Promise.resolve()},(xlfont=function(t){var e,n=this;return this.opt=t=null==t?{}:t,this.sub={set:{},font:{}},this.cjkOnly=t.cjkOnly||!1,this.codemap={},this.otf={font:null,dirty:!0},this.path=t.path,this.name=t.name||this.path.replace(/\.[a-zA-Z0-9]+$/,"").replace(/^https?:\/\/[^/]+\//g,"").replace(/\s/g,"-").replace(/\//g,"-").toLowerCase(),this.style=t.style||"normal",this.weight=t.weight||"400",this.ext=t.ext||(/\.(ttf|otf|woff2|woff)$/.exec(this.path)||[])[1]||"",this.format=(e=this.ext.toLowerCase())?"ttf"===e||"otf"===e?"truetype":e:"",this.format&&(this.format="format('"+this.format+"')"),this.className="xfl-"+(this.name||"").replace(/\s+/g,"_")+"-"+Math.random().toString(36).substring(2),this.isXl=null!=t.isXl?t.isXl:!this.ext,this.ext||(this.ext="woff"),this.doMerge=null!=t.doMerge&&t.doMerge,this.useWorker=null!=t.useWorker&&t.useWorker,this.misschar={},this.css=[],this.init=proxise.once(function(){return n._init()}),this.init(),this}).prototype=import$(Object.create(Object.prototype),{_init:function(){var r=this;return Promise.resolve().then(function(){return r.isXl?new Promise(function(t,e){var n=new XMLHttpRequest;return n.addEventListener("readystatechange",function(){if(n.readyState===XMLHttpRequest.DONE)return 200!==n.status?e(err({code:n.status,message:n.responseText})):((n.responseText||"").split("\n").map(function(t,n){return t.split(" ").map(function(t,e){return r.codemap[t]=n+1})}),t())}),n.open("GET",r.path+"/charmap.txt"),n.send()}):(r.css=[{content:'@font-face {\n  font-family: "'+r.name+'";\n  src: url("'+r.path+'") '+r.format+";\n  font-style: "+r.style+";\n  font-weight: "+r.weight+";\n}\n."+r.className+' { font-family: "'+r.name+'"; }'}],xfl.update())})},_fetch:function(t,e,o){var i=this;return null==t&&(t={}),null==o&&(o="ttf"),(e=null!=e&&e)?t.blob?Promise.resolve(t):(t.proxy||(t.proxy=proxise(function(r){if(!r.running)return r.running=!0,new Promise(function(t,e){var n;return r.blob?t(r):((n=new XMLHttpRequest).addEventListener("readystatechange",function(){if(n.readyState===XMLHttpRequest.DONE)return 200!==n.status?e(err({code:n.status,message:n.responseText})):(i.otf.dirty=!0,r.url=URL.createObjectURL(n.response),r.blob=n.response,r.type=i.ext.toLowerCase()||o,t(r))}),i.isXl?n.open("GET",i.path+"/"+r.key+"."+o):n.open("GET",i.path),n.responseType="blob",n.send())}).finally(function(){return r.running=!1})})),t.proxy(t)):(t.url||(this.isXl?(t.url=this.path+"/"+t.key+"."+o,t.type=o):(t.url=this.path,t.type=this.ext.toLowerCase()||o)),Promise.resolve(t))},fetchAll:function(){var n,r,e=this;return this.isXl?Promise.all(function(){var t,e=[];for(n in t=this.sub.font)r=t[n],e.push(r);return e}.call(this).map(function(t){return e._fetch(t,!0,"woff")})):this._fetch(this.sub.font[0],!0,"ttf")},fetch:function(t,o){var i,u=this;if(null==t&&(t=[]),null==o&&(o=!1),!this.isXl){if(this.sub.font[0]&&this.sub.font[0].blob)return Promise.resolve();t=[0]}return i=this.doMerge,t=Array.from(new Set(t.map(function(t){return t}))).filter(function(t){return!u.sub.font[t]}).map(function(t,e){var n,r;return u.sub.font[t]=n={key:t},r=u.isXl?"woff":"ttf",n.needMerge=1!=+t,u._fetch(n,!!i||o,r)}),Promise.all(t).then(function(n){var t;return i?(t=n.filter(function(t){return t.needMerge}).map(function(r){return new Promise(function(t,e){var n=new FileReader;return n.onerror=function(t){return e(t)},n.onload=function(){return t(n.result)},n.readAsArrayBuffer(r.blob)})}),Promise.all(t).then(function(t){return xlfMerger({bufs:t,useWorker:u.useWorker})}).then(function(t){var e;return t?(e=n.filter(function(t){return t.needMerge})[0],t=new Blob([t],{type:"font/"+(e.type||"ttf")}),e={url:URL.createObjectURL(t),blob:t,type:e.type||"ttf"},n.filter(function(t){return!t.needMerge}).concat([e])):n.filter(function(t){return!t.needMerge})})):n}).then(function(t){var e,n,r,o,i,s;if(t.length){for(n in e="."+u.className+' { font-family: "'+u.name+'"; }',r=u.sub.font)o=r[n];for(i=0,s=t.length;i<s;++i)o=t[i],e+='@font-face {\n  font-family: "'+u.name+'";\n  src: url("'+o.url+"\") format('"+o.type+"');\n  font-style: "+u.style+";\n  font-weight: "+u.weight+";\n}";return u.css.push({content:e})}})},hasChar:function(t){return void 0===this.misschar[t]?void 0:!this.misshcar[t]},getPath:function(t){var i=this,t=import$({text:"",x:0,y:0,fontSize:48},t=null==t?{}:t),s=t.text,u=t.x,f=t.y,l=t.fontSize;return this.sync(s).then(function(){return i.getotf()}).then(function(t){for(var e,n="",r=0,o=s.length;r<o;++r)e=r,n+=i.misschar[s[e]]?" ":s[e];return t.getPath(n,u,f,l)})},getotf:function(){var o=this;return"undefined"==typeof opentype||null===opentype?Promise.reject(err({id:1022,message:"[@plotdb/xfl] need opentype.js to merge subfonts"})):this.otf.dirty?Promise.resolve().then(function(){return o.isXl?o.fetchAll():o.fetch()}).then(function(){var n,r,t=function(){var t,e=[];for(n in t=this.sub.font)r=t[n],e.push(r);return e}.call(o).map(function(e){return e.otf?Promise.resolve(e):opentype.load(e.url).then(function(t){return e.otf=t,e})});return Promise.all(t)}).then(function(t){var e;return 1===(t=null==t?[]:t).length?t[0].otf:(e=t.map(function(t){for(var e,n=[],r=t.otf.glyphs,o=1,i=r.length;o<=i;++o)e=o,n.push(r.glyphs[e]);return n}).reduce(function(t,e){return t.concat(e)},[]).filter(function(t){return t}),o.otf.font=new opentype.Font(((e={familyName:o.name,styleName:o.style||"normal",glyphs:e}).unitsPerEm=(t=t[0].otf).unitsPerEm,e.ascender=t.ascender,e.descender=t.descender,e)),o.otf.font.kerningPairs={},o.otf.font)}):Promise.resolve(this.otf.font)},sync:function(l){var a=this;return null==l&&(l=""),this.isXl?Promise.resolve().then(function(){for(var t,e,n,r,o=[{},{}],i=o[0],s=o[1],u=0,f=l.length;u<f;++u)t=u,e=l.charCodeAt(t),a.cjkOnly&&!xfl.isCJK(e)||(e=a.codemap[e.toString(16)],a.misschar[l[t]]=i[l[t]]=!e,e&&!a.sub.set[e]&&(a.sub.set[e]=s[e]=!0));for(n in(i=function(){var t=[];for(n in i)t.push(n);return t}().filter(function(t){return i[t]})).length&&console.log("[@plotdb/xfl] sync xl-font with following chars unsupported: "+i.join("")),r=[],s)r.push(n);if((o=r).length)return a.fetch(o)}).then(function(){return xfl.update()}):(xfl.update(),Promise.resolve())}}),xfl={range:{CJK:[[12352,12543],[13312,19903],[19968,40959],[63744,64255],[65382,65439],[12593,55197]]},fonts:{},running:{},isCJK:function(e){return this.range.CJK.filter(function(t){return e>=t[0]&&e<=t[1]}).length},proxy:{},update:function(){var n,t,e,r,o,i="";for(n in t=this.fonts)((e=t[n]).css||[]).filter(s).map(u);return i&&((r=document.createElement("style")).textContent=i,r.setAttribute("type","text/css"),document.body.appendChild(r)),Promise.all(function(){var t,e=[];for(n in t=this.fonts)o=t[n],e.push(o);return e}.call(this).map(function(){return document.fonts.load("16px "+e.name)})).then(function(){return new Promise(function(t,e){return setTimeout(function(){return t()},350)})});function s(t){return!t.rendered}function u(t){return t.rendered=!0,i+=t.content}},_load:function(e){var n=this,r=(e=null==e?{}:e).path;if(!this.running[r])return this.running[r]=!0,Promise.resolve().then(function(){var t;return n.fonts[r]=t=new xlfont(e),t.init()}).finally(function(){return n.running[r]=!1}).then(function(){return n.proxy[r].resolve(n.fonts[r]),n.fonts[r]}).catch(function(t){return n.proxy[r].reject(t),Promise.reject(t)})},load:function(o){var i=this;return"string"==typeof(o=null==o?{}:o)&&(o={path:o}),new Promise(function(e,n){var t,r;return(t=o.path)?(t=t.replace(/\/$/,""),(r=i.fonts[t])?e(r):(i.proxy[t]||(i.proxy[t]=proxise(function(t){return i._load(t)})),i.proxy[t](((r=import$({},o)).path=t,r)).then(function(t){return e(t)}).catch(function(t){return n(t)}))):n(err({id:400}))})}},"undefined"!=typeof module&&null!==module?module.exports=xfl:"undefined"!=typeof window&&null!==window&&(window.xfl=xfl);
